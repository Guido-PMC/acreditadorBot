<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vista del Cliente - AcreditadorBot</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    /* Estilos para el dropdown de clientes */
    #clienteNombre:hover {
      color: #0a58ca !important;
      text-decoration: underline;
    }
    
    #clientesDropdown {
      max-height: 400px;
      overflow-y: auto;
      min-width: 320px;
    }
    
    #clientesDropdown .dropdown-item {
      padding: 10px 16px;
    }
    
    #clientesDropdown .dropdown-item:hover {
      background-color: #f8f9fa;
    }
    
    #clientesDropdown .dropdown-item.active {
      background-color: #0d6efd;
      color: white;
    }
    
    #clientesDropdown .dropdown-item.active small {
      color: rgba(255, 255, 255, 0.8);
    }
    
    #clientesDropdown .dropdown-item small {
      font-size: 0.75rem;
      margin-top: 2px;
    }
  </style>
</head>
<body>

  <div class="container">
    <div id="alertContainer"></div>
    
    <!-- Header del Cliente -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="dropdown">
                  <h2 class="dropdown-toggle" id="clienteNombre" data-bs-toggle="dropdown" aria-expanded="false" style="cursor: pointer; color: #0d6efd;">
                    Cargando...
                  </h2>
                  <ul class="dropdown-menu" id="clientesDropdown">
                    <li><span class="dropdown-item-text">Cargando clientes...</span></li>
                  </ul>
                </div>
                <p class="text-muted mb-0" id="clienteInfo">Cargando informaci√≥n...</p>
              </div>
              <div class="text-end">
                <h3 class="text-primary mb-0" id="saldoCliente">$0.00</h3>
                <small class="text-muted">Saldo Actual</small>
                <h3 class="text-muted mb-0" id="porAcreditar">$0.00</h3>
                <small class="text-muted">Por Acreditar</small>
                <br>
                <button class="btn btn-sm btn-success me-2" onclick="openCreditoModal()" title="Nuevo Cr√©dito">
                  <i class="fas fa-plus me-1"></i>Nuevo Cr√©dito
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="debugComprobantes()" title="Debug">
                  <i class="fas fa-bug me-1"></i>Debug
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Primera fila: Contadores de Comprobantes -->
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card bg-primary text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4 id="totalAcreditaciones">0</h4>
                <p class="mb-0">Total Comprobantes</p>
              </div>
              <div class="align-self-center">
                <i class="fas fa-receipt fa-2x"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card bg-success text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4 id="acreditacionesCotejadas">0</h4>
                <p class="mb-0">Comprobantes Asignados</p>
              </div>
              <div class="align-self-center">
                <i class="fas fa-check-circle fa-2x"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card bg-warning text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4 id="acreditacionesPendientes">0</h4>
                <p class="mb-0">Comprobantes Pendientes</p>
              </div>
              <div class="align-self-center">
                <i class="fas fa-clock fa-2x"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Segunda fila: Montos -->
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card bg-info text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4 id="totalMontoAsignados">$0.00</h4>
                <p class="mb-0">Total Comprobantes Asignados</p>
              </div>
              <div class="align-self-center">
                <i class="fas fa-money-bill fa-2x"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card bg-secondary text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4 id="totalComisionesAsignadas">$0.00</h4>
                <p class="mb-0">Total Comisiones</p>
              </div>
              <div class="align-self-center">
                <i class="fas fa-percentage fa-2x"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card bg-warning text-white">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <div>
                <h4 id="totalComisiones">$0.00</h4>
                <p class="mb-0">Total Pendiente</p>
              </div>
              <div class="align-self-center">
                <i class="fas fa-dollar-sign fa-2x"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenido Principal -->
    <div class="row">
      <!-- Movimientos Unificados -->
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>Todos los Movimientos
              </h5>
              <div>
                <button class="btn btn-sm btn-success me-2" onclick="openCreditoModal()">
                  <i class="fas fa-plus me-1"></i>Nuevo Cr√©dito
                </button>
                <button class="btn btn-sm btn-danger me-2" onclick="openPagoModal()">
                  <i class="fas fa-minus me-1"></i>Nuevo Pago
                </button>
                <button class="btn btn-sm btn-outline-secondary me-2" onclick="loadClienteData()" title="Recargar datos">
                  <i class="fas fa-sync-alt"></i>
                </button>
                <span class="badge bg-info" id="movimientosCount">0</span>
              </div>
            </div>
            <!-- PAGINACI√ìN Y SELECTOR -->
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <span id="movimientosPaginacionInfo" class="text-muted small"></span>
              </div>
              <div class="d-flex align-items-center gap-2">
                <small class="text-muted">Mostrar:</small>
                <select class="form-select form-select-sm" id="movimientosPerPage" onchange="cambiarMovimientosPerPage()" style="width: auto;">
                  <option value="25">25</option>
                  <option value="50">50</option>
                  <option value="100" selected>100</option>
                  <option value="500">500</option>
                </select>
                <nav aria-label="Paginaci√≥n de movimientos">
                  <ul class="pagination pagination-sm mb-0" id="movimientosPaginacion"></ul>
                </nav>
              </div>
            </div>
            
            <!-- Filtros de Movimientos -->
            <div class="d-flex justify-content-center">
              <div class="btn-group btn-group-sm" role="group" aria-label="Filtros de movimientos">
                <button type="button" class="btn btn-primary" onclick="filterMovimientos('todos')" id="filter-todos">
                  <i class="fas fa-list me-1"></i>Todos
                </button>
                <button type="button" class="btn btn-outline-warning" onclick="filterMovimientos('pendientes')" id="filter-pendientes">
                  <i class="fas fa-clock me-1"></i>Pendientes
                </button>
                <button type="button" class="btn btn-outline-success" onclick="filterMovimientos('cobros')" id="filter-cobros">
                  <i class="fas fa-plus-circle me-1"></i>Cobros
                </button>
                <button type="button" class="btn btn-outline-info" onclick="filterMovimientos('acreditaciones')" id="filter-acreditaciones">
                  <i class="fas fa-university me-1"></i>Acreditaciones
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="filterMovimientos('pagos')" id="filter-pagos">
                  <i class="fas fa-minus-circle me-1"></i>Pagos
                </button>
              </div>
            </div>
          </div>
          
          <div class="card-body">
            <div id="movimientosContainer">
              <div class="text-center text-muted">Cargando movimientos...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Nuevo Cr√©dito -->
  <div class="modal fade" id="creditoModal" tabindex="-1" aria-labelledby="creditoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="creditoForm" onsubmit="submitCreditoForm(event)">
          <div class="modal-header">
            <h5 class="modal-title" id="creditoModalLabel">Nuevo Cr√©dito</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="clienteIdCredito">
            <div class="mb-3">
              <label for="conceptoCredito" class="form-label">Concepto *</label>
              <input type="text" class="form-control" id="conceptoCredito" required placeholder="Ej: Cr√©dito por servicios prestados">
            </div>
            <div class="mb-3">
              <label for="importeCredito" class="form-label">Importe *</label>
              <input type="number" class="form-control" id="importeCredito" required step="0.01" min="0" placeholder="0.00" oninput="calcularComisionCredito()">
            </div>
            <div class="mb-3">
              <label for="comisionCredito" class="form-label">Comisi√≥n (%)</label>
              <input type="number" class="form-control" id="comisionCredito" min="0" max="100" step="0.01" placeholder="0.00" oninput="calcularComisionCredito()">
              <div class="form-text">Porcentaje de comisi√≥n que se aplicar√° al cr√©dito (0-100%)</div>
              <div id="comisionCalculadaCredito" class="form-text text-info" style="display: none;"></div>
            </div>
            <div class="mb-3">
              <label for="fechaCredito" class="form-label">Fecha del Cr√©dito</label>
              <input type="datetime-local" class="form-control" id="fechaCredito">
            </div>
            <div class="mb-3">
              <label for="metodoCredito" class="form-label">M√©todo de Cr√©dito *</label>
              <select class="form-select" id="metodoCredito" required>
                <option value="">Seleccionar...</option>
                <option value="deposito">Dep√≥sito</option>
                <option value="otro">Otro</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="referenciaCredito" class="form-label">Referencia</label>
              <input type="text" class="form-control" id="referenciaCredito" placeholder="N√∫mero de comprobante, CBU, etc.">
            </div>
            <div class="mb-3">
              <label for="observacionesCredito" class="form-label">Observaciones</label>
              <textarea class="form-control" id="observacionesCredito" rows="3" placeholder="Detalles adicionales del cr√©dito"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-success">
              <i class="fas fa-plus me-1"></i>Registrar Cr√©dito
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Nuevo Pago -->
  <div class="modal fade" id="pagoModal" tabindex="-1" aria-labelledby="pagoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="pagoForm" onsubmit="submitPagoForm(event)">
          <div class="modal-header">
            <h5 class="modal-title" id="pagoModalLabel">Nuevo Pago</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="clienteIdPago">
            <div class="mb-3">
              <label for="concepto" class="form-label">Concepto *</label>
              <input type="text" class="form-control" id="concepto" required placeholder="Ej: Pago por servicios">
            </div>
            <div class="mb-3">
              <label for="importe" class="form-label">Importe *</label>
              <input type="number" class="form-control" id="importe" required step="0.01" min="0" placeholder="0.00">
            </div>
            <div class="mb-3">
              <label for="fechaPago" class="form-label">Fecha de Pago</label>
              <input type="datetime-local" class="form-control" id="fechaPago">
            </div>
            <div class="mb-3">
              <label for="metodoPago" class="form-label">M√©todo de Pago</label>
              <select class="form-select" id="metodoPago">
                <option value="">Seleccionar...</option>
                <option value="transferencia">Transferencia</option>
                <option value="efectivo">Efectivo</option>
                <option value="cheque">Cheque</option>
                <option value="tarjeta">Tarjeta</option>
                <option value="otro">Otro</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="referencia" class="form-label">Referencia</label>
              <input type="text" class="form-control" id="referencia" placeholder="N√∫mero de comprobante, etc.">
            </div>
            <div class="mb-3">
              <label for="observacionesPago" class="form-label">Observaciones</label>
              <textarea class="form-control" id="observacionesPago" rows="3" placeholder="Observaciones adicionales"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-success">Registrar Pago</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/navbar.js"></script>
  <script>
    let clienteId = null;
    let allMovimientos = [];
    let currentFilter = 'todos';
    let movimientosPage = 1;
    let movimientosLimit = 100;
    let movimientosTotal = 0;
    let movimientosPages = 1;

    // Obtener ID del cliente de la URL
    function getClienteId() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('id');
    }

    // Cargar datos del cliente
    async function loadClienteData() {
      clienteId = getClienteId();
      if (!clienteId) {
        showAlert('danger', 'ID de cliente no especificado');
        return;
      }

      try {
        const res = await fetch(`/api/clientes/${clienteId}/resumen`);
        const data = await res.json();
        if (!data.success) {
          showAlert('danger', data.error || 'Error al cargar datos del cliente');
          return;
        }
        renderClienteInfo(data.data);
        movimientosPage = 1; // Resetear a la primera p√°gina
        loadMovimientosUnificados();
        loadClientesDropdown();
      } catch (error) {
        showAlert('danger', 'Error al cargar datos del cliente');
      }
    }

    // Cargar lista de clientes para el dropdown
    async function loadClientesDropdown() {
      try {
        const res = await fetch('/api/clientes?limit=100'); // Obtener hasta 100 clientes
        const data = await res.json();
        
        if (!data.success) {
          console.error('Error al cargar lista de clientes:', data.error);
          return;
        }

        const dropdown = document.getElementById('clientesDropdown');
        const clientes = data.data;
        
        // Limpiar dropdown
        dropdown.innerHTML = '';
        
        // Agregar header
        dropdown.innerHTML += `
          <li><h6 class="dropdown-header">Seleccionar Cliente</h6></li>
          <li><hr class="dropdown-divider"></li>
        `;
        
        // Agregar clientes
        clientes.forEach(cliente => {
          const isCurrentClient = parseInt(cliente.id) === parseInt(clienteId);
          dropdown.innerHTML += `
            <li>
              <a class="dropdown-item ${isCurrentClient ? 'active' : ''}" 
                 href="?id=${cliente.id}" 
                 ${isCurrentClient ? 'aria-current="true"' : ''}>
                <i class="fas fa-user me-2"></i>
                ${cliente.nombre} ${cliente.apellido || ''}
                <small class="text-muted d-block">ID: ${cliente.id} ‚Ä¢ ${cliente.estado}</small>
              </a>
            </li>
          `;
        });
        
        // Agregar opci√≥n para ver todos los clientes
        dropdown.innerHTML += `
          <li><hr class="dropdown-divider"></li>
          <li>
            <a class="dropdown-item" href="/clientes.html">
              <i class="fas fa-list me-2"></i>
              Ver todos los clientes
            </a>
          </li>
        `;
        
      } catch (error) {
        console.error('Error al cargar lista de clientes:', error);
        const dropdown = document.getElementById('clientesDropdown');
        dropdown.innerHTML = '<li><span class="dropdown-item-text text-danger">Error al cargar clientes</span></li>';
      }
    }

    // Renderizar informaci√≥n del cliente
    function renderClienteInfo(data) {
      const cliente = data.cliente;
      const resumen = data.resumen;

      console.log('üîç Renderizando informaci√≥n del cliente:', { cliente, resumen });

      // Funci√≥n auxiliar para actualizar elemento de forma segura
      function updateElement(id, content) {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = content;
          console.log(`‚úÖ ${id} actualizado:`, content);
        } else {
          console.error(`‚ùå Elemento ${id} no encontrado`);
        }
      }

      // Informaci√≥n del cliente
      updateElement('clienteNombre', `${cliente.nombre} ${cliente.apellido || ''}`);
      updateElement('clienteInfo', `Cliente ID: ${cliente.id} ‚Ä¢ Estado: ${cliente.estado}`);
      
      // Saldo - UNIFICADO CON PORTAL DASHBOARD
      const porAcreditar = data.resumen?.porAcreditar || 0;
      let saldo_actual = data.resumen?.saldo_actual || 0;

      // Restar comisiones de fondos liberados seg√∫n lo solicitado
      if (data.resumen?.debug_saldo) {
        const comisiones_acreditaciones_liberadas = data.resumen.debug_saldo.comisiones_acreditaciones_liberadas || 0;
        const comisiones_depositos_liberados = data.resumen.debug_saldo.comisiones_depositos_liberados || 0;
        
        // Aplicar la f√≥rmula: saldo_actual = saldo_actual - comisiones_acreditaciones_liberadas - comisiones_depositos_liberados
        saldo_actual = saldo_actual - comisiones_acreditaciones_liberadas - comisiones_depositos_liberados;
        
        console.log('üîç Cliente.html - Ajuste de saldo actual:', {
          saldo_original: data.resumen.saldo_actual,
          comisiones_acreditaciones_liberadas,
          comisiones_depositos_liberados,
          saldo_final: saldo_actual
        });
      }

      updateElement('porAcreditar', formatCurrency(porAcreditar));
      updateElement('saldoCliente', formatCurrency(saldo_actual));

      // Guardar el saldo actual como saldo inicial para los c√°lculos de saldo acumulado
      saldoInicialCliente = saldo_actual;
      
      // Primera fila: Contadores de comprobantes (con formato de miles)
      updateElement('totalAcreditaciones', (resumen.comprobantes.total_comprobantes || 0).toLocaleString('es-AR'));
      updateElement('acreditacionesCotejadas', (resumen.comprobantes.comprobantes_asignados || 0).toLocaleString('es-AR'));
      updateElement('acreditacionesPendientes', (resumen.comprobantes.comprobantes_sin_asignar || 0).toLocaleString('es-AR'));
      
      // Segunda fila: Montos
      // Total de comprobantes asignados en monto (acreditaciones cotejadas)
      const totalMontoAsignados = resumen.acreditaciones?.total_importe_cotejadas || 0;
      console.log('üîç totalMontoAsignados original:', totalMontoAsignados);
      const montoAsignadosFormatted = formatCurrency(totalMontoAsignados);
      console.log('üîç totalMontoAsignados formateado:', montoAsignadosFormatted);
      updateElement('totalMontoAsignados', montoAsignadosFormatted);
      
      // Total comisiones (de acreditaciones cotejadas)
      const totalComisionesAsignadas = resumen.acreditaciones?.total_comisiones_cotejadas || 0;
      updateElement('totalComisionesAsignadas', formatCurrency(totalComisionesAsignadas));
      
      // Total comprobantes pendientes: comprobantes sin acreditar
      const total_comprobantes_pendientes = resumen.comprobantes?.total_importe_pendientes || 0;
      console.log('üîç C√°lculo Total Comprobantes Pendientes:', {
        total_comprobantes_pendientes
      });
      updateElement('totalComisiones', formatCurrency(total_comprobantes_pendientes));
    }

    // Funci√≥n para formatear moneda en espa√±ol argentino
    function formatCurrency(amount) {
      if (amount === null || amount === undefined || isNaN(amount)) {
        return '$0,00';
      }
      
      // Asegurar que sea un n√∫mero
      const numAmount = parseFloat(amount);
      
      // Formatear con separador de miles espa√±ol (punto) y decimales (coma)
      const formatted = numAmount.toLocaleString('es-AR', { 
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
      
      return `$${formatted}`;
    }

    // Funci√≥n para limpiar CUIT (quitar guiones y dejar solo n√∫meros)
    function cleanCUIT(cuit) {
      if (!cuit) return '';
      return cuit.replace(/[^0-9]/g, '');
    }

    // Funci√≥n para obtener el color del badge seg√∫n la fuente
    function getFuenteBadgeClass(fuente) {
      switch (fuente?.toLowerCase()) {
        case 'historico':
          return 'bg-primary';
        case 'whatsapp':
          return 'bg-success';
        case 'csv':
          return 'bg-warning';
        case 'manual':
          return 'bg-secondary';
        default:
          return 'bg-info';
      }
    }

    // Funci√≥n para obtener el texto de la fuente
    function getFuenteText(fuente) {
      switch (fuente?.toLowerCase()) {
        case 'historico':
          return 'Hist√≥rico';
        case 'whatsapp':
          return 'WhatsApp';
        case 'csv':
          return 'CSV';
        case 'manual':
          return 'Manual';
        default:
          return fuente || 'N/A';
      }
    }

    // Abrir modal de pago
    function openPagoModal() {
      document.getElementById('pagoForm').reset();
      document.getElementById('clienteIdPago').value = clienteId;
      document.getElementById('fechaPago').value = new Date().toISOString().slice(0, 16);
      new bootstrap.Modal(document.getElementById('pagoModal')).show();
    }

    // Abrir modal de cr√©dito
    function openCreditoModal() {
      document.getElementById('creditoForm').reset();
      document.getElementById('clienteIdCredito').value = clienteId;
      document.getElementById('fechaCredito').value = new Date().toISOString().slice(0, 16);
      new bootstrap.Modal(document.getElementById('creditoModal')).show();
    }

    // Enviar formulario de cr√©dito
    async function submitCreditoForm(event) {
      event.preventDefault();
      
      // Validar que se haya seleccionado un m√©todo de cr√©dito
      const metodoCredito = document.getElementById('metodoCredito').value;
      if (!metodoCredito || metodoCredito === '') {
        showAlert('danger', 'Debe seleccionar un m√©todo de cr√©dito');
        return;
      }
      
      const importe = parseFloat(document.getElementById('importeCredito').value);
      const comisionPorcentaje = parseFloat(document.getElementById('comisionCredito').value) || 0;
      const importeComision = (importe * comisionPorcentaje) / 100;
      
      const body = {
        id_cliente: parseInt(document.getElementById('clienteIdCredito').value),
        concepto: document.getElementById('conceptoCredito').value,
        importe: importe,
        fecha_pago: document.getElementById('fechaCredito').value,
        metodo_pago: metodoCredito,
        referencia: document.getElementById('referenciaCredito').value,
        observaciones: document.getElementById('observacionesCredito').value,
        tipo_pago: 'credito', // Marcar como cr√©dito en lugar de pago
        comision: comisionPorcentaje,
        importe_comision: importeComision
      };

      try {
        const res = await fetch('/api/pagos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        
        const data = await res.json();
        
        if (data.success) {
          showAlert('success', data.message);
          bootstrap.Modal.getInstance(document.getElementById('creditoModal')).hide();
          loadClienteData(); // Recargar todo para actualizar saldo
        } else {
          showAlert('danger', data.error || data.message || 'Error al registrar cr√©dito');
        }
      } catch (error) {
        showAlert('danger', 'Error al registrar cr√©dito');
      }
    }

    // Enviar formulario de pago
    async function submitPagoForm(event) {
      event.preventDefault();
      
      const body = {
        id_cliente: parseInt(document.getElementById('clienteIdPago').value),
        concepto: document.getElementById('concepto').value,
        importe: parseFloat(document.getElementById('importe').value),
        fecha_pago: document.getElementById('fechaPago').value,
        metodo_pago: document.getElementById('metodoPago').value,
        referencia: document.getElementById('referencia').value,
        observaciones: document.getElementById('observacionesPago').value
      };

      try {
        const res = await fetch('/api/pagos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        
        const data = await res.json();
        
        if (data.success) {
          showAlert('success', data.message);
          bootstrap.Modal.getInstance(document.getElementById('pagoModal')).hide();
          loadClienteData(); // Recargar todo para actualizar saldo
        } else {
          showAlert('danger', data.error || data.message || 'Error al registrar pago');
        }
      } catch (error) {
        showAlert('danger', 'Error al registrar pago');
      }
    }

    // Eliminar pago
    async function deletePago(id) {
      if (!confirm('¬øSeguro que deseas eliminar este pago?')) return;
      
      try {
        const res = await fetch(`/api/pagos/${id}`, { method: 'DELETE' });
        const data = await res.json();
        
        if (data.success) {
          showAlert('success', data.message);
          loadClienteData(); // Recargar todo para actualizar saldo
        } else {
          showAlert('danger', data.error || data.message || 'Error al eliminar pago');
        }
      } catch (error) {
        showAlert('danger', 'Error al eliminar pago');
      }
    }

    // Desasignar comprobante
    async function desasignarComprobante(id) {
      if (!confirm('¬øSeguro que deseas desasignar este comprobante?')) return;
      
      try {
        const res = await fetch(`/api/comprobantes/${id}/desasignar`, { method: 'PUT' });
        const data = await res.json();
        
        if (data.success) {
          showAlert('success', data.message);
          loadClienteData(); // Recargar todo para actualizar datos
        } else {
          showAlert('danger', data.error || data.message || 'Error al desasignar comprobante');
        }
      } catch (error) {
        showAlert('danger', 'Error al desasignar comprobante');
      }
    }

    // Cargar todos los movimientos del cliente usando la nueva ruta unificada
    async function loadMovimientosUnificados() {
      try {
        console.log('üîç Cargando todos los movimientos del cliente:', clienteId);
        const response = await fetch(`/api/clientes/${clienteId}/movimientos-unificados?page=${movimientosPage}&limit=${movimientosLimit}`);
        const result = await response.json();
        if (!result.success) {
          console.error('Error al cargar movimientos unificados:', result);
          showAlert('danger', 'Error al cargar movimientos');
          return;
        }
        allMovimientos = result.data;
        movimientosTotal = result.pagination?.total || allMovimientos.length;
        movimientosPages = result.pagination?.pages || 1;
        renderMovimientosUnificados(allMovimientos);
        renderMovimientosPaginacion();
        document.getElementById('movimientosCount').textContent = movimientosTotal;
      } catch (error) {
        console.error('Error cargando movimientos:', error);
        showAlert('danger', 'Error al cargar movimientos');
      }
    }

    function renderMovimientosPaginacion() {
      const paginacion = document.getElementById('movimientosPaginacion');
      const info = document.getElementById('movimientosPaginacionInfo');
      if (!paginacion || !info) return;
      let html = '';
      // Bot√≥n anterior
      html += `<li class="page-item${movimientosPage <= 1 ? ' disabled' : ''}"><a class="page-link" href="#" onclick="cambiarMovimientosPage(${movimientosPage - 1}); return false;">&laquo;</a></li>`;
      // N√∫meros de p√°gina
      for (let i = 1; i <= movimientosPages; i++) {
        if (i === 1 || i === movimientosPages || (i >= movimientosPage - 2 && i <= movimientosPage + 2)) {
          html += `<li class="page-item${i === movimientosPage ? ' active' : ''}"><a class="page-link" href="#" onclick="cambiarMovimientosPage(${i}); return false;">${i}</a></li>`;
        } else if (i === movimientosPage - 3 || i === movimientosPage + 3) {
          html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
      }
      // Bot√≥n siguiente
      html += `<li class="page-item${movimientosPage >= movimientosPages ? ' disabled' : ''}"><a class="page-link" href="#" onclick="cambiarMovimientosPage(${movimientosPage + 1}); return false;">&raquo;</a></li>`;
      paginacion.innerHTML = html;
      info.textContent = `P√°gina ${movimientosPage} de ${movimientosPages} ‚Ä¢ Total: ${movimientosTotal} movimientos`;
    }

    function cambiarMovimientosPage(page) {
      if (page < 1 || page > movimientosPages) return;
      movimientosPage = page;
      loadMovimientosUnificados();
    }

    function cambiarMovimientosPerPage() {
      const select = document.getElementById('movimientosPerPage');
      movimientosLimit = parseInt(select.value);
      movimientosPage = 1;
      loadMovimientosUnificados();
    }

    // Funci√≥n de debug para verificar estado de la base de datos
    async function debugComprobantes() {
      console.log('üîç Iniciando debug de comprobantes...');
      
      try {
        // Verificar resumen del cliente
        const resumenRes = await fetch(`/api/clientes/${clienteId}/resumen`);
        const resumenData = await resumenRes.json();
        console.log('üìä Resumen del cliente:', resumenData.data.resumen);
        
        // Verificar comprobantes del cliente
        const comprobantesRes = await fetch(`/api/clientes/${clienteId}/comprobantes?limit=100`);
        const comprobantesData = await comprobantesRes.json();
        console.log('üìã Comprobantes del cliente:', comprobantesData.data);
        
        // Verificar comprobantes sin asignar
        const sinAsignarRes = await fetch('/api/comprobantes/sin-acreditacion?limit=100');
        const sinAsignarData = await sinAsignarRes.json();
        console.log('‚ùå Comprobantes sin asignar:', sinAsignarData.data);
        
        // Verificar acreditaciones sin comprobante
        const acreditacionesRes = await fetch('/api/acreditaciones/sin-comprobante?limit=100');
        const acreditacionesData = await acreditacionesRes.json();
        console.log(' Comprobantes sin comprobante:', acreditacionesData.data);
        
        showAlert('info', 'Debug completado. Revisa la consola para m√°s detalles.');
        
      } catch (error) {
        console.error('Error en debug:', error);
        showAlert('danger', 'Error en debug');
      }
    }

    // Mostrar alerta
    function showAlert(type, message) {
      document.getElementById('alertContainer').innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      `;
    }

    // Funci√≥n para filtrar movimientos
    function filterMovimientos(tipo) {
      currentFilter = tipo;
      
      // Resetear todos los botones a su estado outline
      document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.className = 'btn btn-outline-primary btn-sm'; // Reset base classes
      });
      
      // Configurar cada bot√≥n seg√∫n su tipo
      document.getElementById('filter-todos').className = 'btn btn-outline-primary btn-sm';
      document.getElementById('filter-pendientes').className = 'btn btn-outline-warning btn-sm';
      document.getElementById('filter-cobros').className = 'btn btn-outline-success btn-sm';
      document.getElementById('filter-pagos').className = 'btn btn-outline-secondary btn-sm';
      
      // Activar el bot√≥n seleccionado
      const activeButton = document.getElementById(`filter-${tipo}`);
      if (activeButton) {
        // Remover outline y agregar color s√≥lido
        if (tipo === 'todos') {
          activeButton.className = 'btn btn-primary btn-sm';
        } else if (tipo === 'pendientes') {
          activeButton.className = 'btn btn-warning btn-sm';
        } else if (tipo === 'cobros') {
          activeButton.className = 'btn btn-success btn-sm';
        } else if (tipo === 'pagos') {
          activeButton.className = 'btn btn-secondary btn-sm';
        }
      }
      
      applyCurrentFilter();
    }

    // Aplicar filtro actual
    function applyCurrentFilter() {
      let movimientosFiltrados = allMovimientos;
      
      switch (currentFilter) {
        case 'pendientes':
          // Comprobantes sin acreditaci√≥n
          movimientosFiltrados = allMovimientos.filter(mov => 
            mov.tipo === 'comprobante' && !mov.id_acreditacion
          );
          break;
        case 'cobros':
          // Comprobantes acreditados y cr√©ditos
          movimientosFiltrados = allMovimientos.filter(mov => 
            (mov.tipo === 'comprobante' && mov.id_acreditacion) || mov.tipo === 'credito'
          );
          break;
        case 'acreditaciones':
          // Solo acreditaciones
          movimientosFiltrados = allMovimientos.filter(mov => 
            mov.tipo === 'acreditacion'
          );
          break;
        case 'pagos':
          // Solo pagos
          movimientosFiltrados = allMovimientos.filter(mov => 
            mov.tipo === 'pago'
          );
          break;
        case 'todos':
        default:
          movimientosFiltrados = allMovimientos;
          break;
      }
      
      renderMovimientosUnificados(movimientosFiltrados);
      document.getElementById('movimientosCount').textContent = movimientosFiltrados.length;
    }

    // Funci√≥n para calcular comisi√≥n en tiempo real
    function calcularComisionCredito() {
      const importe = parseFloat(document.getElementById('importeCredito').value) || 0;
      const comisionPorcentaje = parseFloat(document.getElementById('comisionCredito').value) || 0;
      const importeComision = (importe * comisionPorcentaje) / 100;
      const neto = importe - importeComision;
      
      const divComision = document.getElementById('comisionCalculadaCredito');
      if (comisionPorcentaje > 0 && importe > 0) {
        divComision.innerHTML = `
          <strong>C√°lculo:</strong> $${importe.toLocaleString('es-AR', { minimumFractionDigits: 2 })} √ó ${comisionPorcentaje}% = 
          $${importeComision.toLocaleString('es-AR', { minimumFractionDigits: 2 })} de comisi√≥n<br>
          <strong>Neto:</strong> $${neto.toLocaleString('es-AR', { minimumFractionDigits: 2 })}
        `;
        divComision.style.display = 'block';
      } else {
        divComision.style.display = 'none';
      }
    }

    // Funci√≥n de debug para inspeccionar movimientos
    window.debugMovimientos = function() {
      console.log('üîç Debug - allMovimientos:', allMovimientos);
      console.log('üîç Debug - movimientos con comisi√≥n:');
      allMovimientos.forEach((mov, index) => {
        if (mov.comision > 0 || mov.importe_comision > 0) {
          console.log(`  ${index}:`, {
            tipo: mov.tipo,
            concepto: mov.concepto,
            importe: mov.importe,
            comision: mov.comision,
            importe_comision: mov.importe_comision,
            id_acreditacion: mov.id_acreditacion,
            cotejado: mov.cotejado
          });
        }
      });
    };

    // Inicializar cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ DOM cargado, inicializando cliente...');
      loadClienteData();
    });

    // Backup para window.onload
    window.addEventListener('load', function() {
      console.log('üîÑ Window.onload ejecutado como backup');
      if (!clienteId) {
        loadClienteData();
      }
    });

    // Variable para almacenar el saldo inicial del cliente
    let saldoInicialCliente = 0;

    // Renderizar movimientos unificados en una lista compacta
    function renderMovimientosUnificados(movimientos) {
      const container = document.getElementById('movimientosContainer');
      if (!movimientos || movimientos.length === 0) {
        container.innerHTML = '<div class="text-center text-muted">No hay movimientos para mostrar.</div>';
        return;
      }

      // Ordenar movimientos por fecha (m√°s antiguos primero para calcular saldo acumulado)
      const movimientosOrdenados = [...movimientos].sort((a, b) => {
        const fechaA = new Date(a.fecha_original || a.fecha || a.fecha_pago || a.fecha_hora || a.created_at);
        const fechaB = new Date(b.fecha_original || b.fecha || b.fecha_pago || b.fecha_hora || b.created_at);
        return fechaA - fechaB;
      });

      // Calcular saldo acumulado para cada movimiento considerando fechas de liberaci√≥n
      let saldoAcumulado = saldoInicialCliente;
      const movimientosConSaldo = movimientosOrdenados.map(mov => {
        // Determinar si es entrada o salida Y si est√° liberado
        let esEntrada = false;
        let estaLiberado = true; // Por defecto asumimos que est√° liberado
        const fechaActual = new Date();
        
        if (mov.tipo === 'acreditacion' || (mov.tipo === 'comprobante' && mov.id_acreditacion)) {
          esEntrada = true;
          // Para acreditaciones, verificar si est√° liberado seg√∫n la fecha estimada
          if (mov.fecha_estimada_liberacion) {
            estaLiberado = fechaActual >= new Date(mov.fecha_estimada_liberacion);
          } else {
            estaLiberado = true; // Si no hay fecha estimada, asumimos liberado
          }
        } else if (mov.tipo === 'credito') {
          esEntrada = true;
          // Los cr√©ditos tipo dep√≥sito pueden tener plazo de liberaci√≥n
          if (mov.metodo_pago && mov.metodo_pago.toLowerCase() === 'deposito') {
            if (mov.fecha_estimada_liberacion) {
              estaLiberado = fechaActual >= new Date(mov.fecha_estimada_liberacion);
            } else {
              estaLiberado = mov.esta_liberado !== false; // Si no est√° definido, asumimos liberado
            }
          } else {
            estaLiberado = true; // Otros cr√©ditos est√°n inmediatamente disponibles
          }
        } else if (mov.tipo === 'pago') {
          esEntrada = false;
          estaLiberado = true; // Los pagos siempre restan inmediatamente
        }

        // Calcular importe neto (descontando comisiones)
        const importeBruto = parseFloat(mov.importe || 0);
        const comision = parseFloat(mov.importe_comision || 0);
        const importeNeto = importeBruto - comision;

        // Solo actualizar saldo acumulado si el movimiento est√° liberado
        if (estaLiberado) {
          if (esEntrada) {
            saldoAcumulado += importeNeto;
          } else {
            saldoAcumulado -= importeBruto; // Los pagos no tienen comisi√≥n descontada
          }
        }

        return {
          ...mov,
          saldoAcumulado: saldoAcumulado,
          esEntrada: esEntrada,
          importeNeto: importeNeto,
          estaLiberado: estaLiberado
        };
      });

      // Ordenar nuevamente por fecha (m√°s recientes primero para mostrar)
      const movimientosParaMostrar = movimientosConSaldo.sort((a, b) => {
        const fechaA = new Date(a.fecha_original || a.fecha || a.fecha_pago || a.fecha_hora || a.created_at);
        const fechaB = new Date(b.fecha_original || b.fecha || b.fecha_pago || b.fecha_hora || b.created_at);
        return fechaB - fechaA;
      });

      let html = `<div class="table-responsive"><table class="table table-sm align-middle mb-0"><thead><tr>
        <th>ID</th>
        <th>Fecha</th>
        <th>Tipo</th>
        <th>Concepto</th>
        <th class="text-end">Importe</th>
        <th class="text-end">Comisi√≥n</th>
        <th>Estado</th>
        <th class="text-end">Saldo Acumulado</th>
      </tr></thead><tbody>`;
      const now = new Date();
      movimientosParaMostrar.forEach(mov => {
        let fecha = mov.fecha || mov.fecha_pago || mov.fecha_hora || mov.created_at || '';
        if (fecha) {
          // Usar formatDatePreserveTime para comprobantes (que vienen en UTC)
          // Usar formatDate para otros movimientos (que vienen en zona local)
          if (mov.tipo === 'comprobante') {
            fecha = formatDatePreserveTime(fecha);
          } else {
            fecha = formatDate(fecha);
          }
        }
        let tipoBadge = '';
        if (mov.tipo === 'pago') tipoBadge = '<span class="badge bg-danger">Pago</span>';
        else if (mov.tipo === 'credito') tipoBadge = '<span class="badge bg-success">Cr√©dito</span>';
        else if (mov.tipo === 'comprobante') tipoBadge = '<span class="badge bg-warning text-dark">Comprobante</span>';
        else if (mov.tipo === 'acreditacion') tipoBadge = '<span class="badge bg-info">Cobro</span>';
        else tipoBadge = `<span class="badge bg-secondary">${mov.tipo || 'Otro'}</span>`;
        let concepto = '';
        if (mov.tipo === 'acreditacion' && mov.titular) {
          concepto = mov.titular;
        } else {
          concepto = mov.concepto || mov.referencia || mov.descripcion || mov.detalle || '-';
        }
        let importe = mov.importe !== undefined ? parseFloat(mov.importe).toLocaleString('es-AR', { style: 'currency', currency: 'ARS' }) : '-';
        let importeClass = 'text-end';
        if (mov.tipo === 'pago') importeClass += ' text-danger';
        else if (mov.tipo === 'credito' || mov.tipo === 'acreditacion') importeClass += ' text-success';
        else if (mov.tipo === 'comprobante') importeClass += ' text-warning';
        let comision = mov.importe_comision !== undefined ? parseFloat(mov.importe_comision).toLocaleString('es-AR', { style: 'currency', currency: 'ARS' }) : '-';
        let estado = mov.estado || (mov.cotejado === true ? 'Acreditado' : mov.cotejado === false ? 'Pendiente' : '-');
        let estadoBadge = '';
        let pendienteLiberacion = false;
        let tooltip = '';
        if ((mov.tipo === 'comprobante' || mov.tipo === 'acreditacion') && mov.fecha_estimada_liberacion) {
          const fechaLiberacion = new Date(mov.fecha_estimada_liberacion);
          const fechaFormateada = formatDate(mov.fecha_estimada_liberacion);
          tooltip = `data-bs-toggle="tooltip" data-bs-placement="top" title="Se libera el ${fechaFormateada}"`;
          
          // Debug para ver las fechas
          console.log('üîç Debug liberaci√≥n:', {
            concepto: mov.concepto,
            fecha_estimada_liberacion: mov.fecha_estimada_liberacion,
            fechaLiberacion: fechaLiberacion.toISOString(),
            now: now.toISOString(),
            es_mayor: fechaLiberacion > now,
            diferencia_ms: fechaLiberacion.getTime() - now.getTime(),
            diferencia_horas: (fechaLiberacion.getTime() - now.getTime()) / (1000 * 60 * 60)
          });
          
          // Determinar si est√° pendiente de liberaci√≥n
          if (fechaLiberacion > now) {
            pendienteLiberacion = true;
            console.log('üîç Debug - Marcando como pendiente de liberaci√≥n');
          } else {
            console.log('üîç Debug - Marcando como liberado (fecha ya pas√≥)');
          }
        }
        
        // L√≥gica de badges
        if (mov.tipo === 'comprobante' && !mov.id_acreditacion) {
          // Comprobantes sin acreditaci√≥n siempre est√°n "Por acreditar"
          estadoBadge = '<span class="badge bg-secondary">Por acreditar</span>';
        } else if (pendienteLiberacion) {
          estadoBadge = `<span class="badge bg-secondary" ${tooltip}>Por acreditar</span>`;
        } else if (mov.tipo === 'comprobante' || mov.tipo === 'acreditacion') {
          if (mov.fecha_estimada_liberacion && new Date(mov.fecha_estimada_liberacion) <= now) {
            console.log('üîç Debug - Marcando como liberado:', {
              concepto: mov.concepto,
              fecha_estimada_liberacion: mov.fecha_estimada_liberacion,
              fechaLiberacion: new Date(mov.fecha_estimada_liberacion).toISOString(),
              now: now.toISOString(),
              es_menor_igual: new Date(mov.fecha_estimada_liberacion) <= now
            });
            estadoBadge = `<span class="badge bg-success" ${tooltip}>Liberado</span>`;
          } else if (estado === 'Acreditado') {
            estadoBadge = '<span class="badge bg-success">Acreditado</span>';
          } else if (estado === 'Pendiente') {
            estadoBadge = '<span class="badge bg-warning text-dark">Pendiente</span>';
          } else if (estado) {
            estadoBadge = `<span class="badge bg-secondary">${estado}</span>`;
          }
        } else {
          if (estado === 'Acreditado') estadoBadge = '<span class="badge bg-success">Acreditado</span>';
          else if (estado === 'Pendiente') estadoBadge = '<span class="badge bg-warning text-dark">Pendiente</span>';
          else if (estado === 'confirmado') estadoBadge = '<span class="badge bg-success">Confirmado</span>';
          else if (estado) estadoBadge = `<span class="badge bg-secondary">${estado}</span>`;
        }
        // Formatear saldo acumulado
        const saldoAcumuladoFormatted = mov.saldoAcumulado.toLocaleString('es-AR', { style: 'currency', currency: 'ARS' });
        const saldoClass = mov.saldoAcumulado >= 0 ? 'text-success' : 'text-danger';
        
        // Agregar indicador si el movimiento no est√° liberado
        let saldoContent = saldoAcumuladoFormatted;
        if (!mov.estaLiberado && mov.esEntrada) {
          saldoContent += ` <small class="text-muted" title="Pendiente de liberaci√≥n">‚è≥</small>`;
        }

        html += `<tr>
          <td><code>${mov.id || '-'}</code></td>
          <td>${fecha}</td>
          <td>${tipoBadge}</td>
          <td>${concepto}</td>
          <td class="${importeClass}">${importe}</td>
          <td class="text-end">${comision}</td>
          <td>${estadoBadge}</td>
          <td class="text-end fw-bold ${saldoClass}">${saldoContent}</td>
        </tr>`;
      });
      html += '</tbody></table></div>';
      container.innerHTML = html;
      
      // Inicializar tooltips despu√©s de renderizar
      const tooltipTriggerList = [].slice.call(container.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
      });
    }
  </script>
</body>
</html> 