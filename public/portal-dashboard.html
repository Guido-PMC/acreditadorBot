<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Clientes - AcreditadorBot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .navbar-brand {
            font-weight: bold;
        }
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
            border-radius: 0.5rem;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .stats-card.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        .stats-card.warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }
        .stats-card.info {
            background: linear-gradient(135deg, #495057 0%, #343a40 100%);
            color: white;
        }
        .table th {
            background-color: #f8f9fa;
            border-top: none;
            cursor: pointer;
            user-select: none;
        }
        .table th:hover {
            background-color: #e9ecef;
        }
        .table th.sortable::after {
            content: '‚Üï';
            margin-left: 0.5rem;
            opacity: 0.5;
        }
        .table th.sort-asc::after {
            content: '‚Üë';
            opacity: 1;
        }
        .table th.sort-desc::after {
            content: '‚Üì';
            opacity: 1;
        }
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .status-badge {
            font-size: 0.75rem;
        }
        .nav-tabs .nav-link {
            border: none;
            border-bottom: 2px solid transparent;
            color: #6c757d;
        }
        .nav-tabs .nav-link.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: 600;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .alert {
            border-radius: 0.375rem;
        }
        .balance-positive {
            color: #28a745;
            font-weight: bold;
        }
        .balance-negative {
            color: #dc3545;
            font-weight: bold;
        }
        .balance-zero {
            color: #6c757d;
            font-weight: bold;
        }
        .stats-card.primary {
            border-left: 4px solid #007bff;
        }
        .stats-card.success {
            border-left: 4px solid #28a745;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary border-bottom shadow-sm mb-4">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="/portal-dashboard.html">
                <i class="fas fa-robot me-2"></i>AcreditadorBot
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link active" href="/portal-dashboard.html"><i class="fas fa-tachometer-alt me-1"></i>Dashboard</a></li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i>
                            <span id="userName">Usuario</span>
                            <span id="userComision" class="badge bg-light text-dark ms-1"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="showProfile()"><i class="fas fa-user-circle me-2"></i>Mi Perfil</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Cerrar Sesi√≥n</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Alertas -->
        <div id="alerts"></div>

        <!-- Resumen de estad√≠sticas -->
        <div class="row mb-4" id="statsRow">
            <div class="col-md-3 mb-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Total Acreditaciones</h6>
                                <h3 id="totalAcreditaciones">-</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-file-invoice-dollar fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stats-card warning">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Saldo Pendiente</h6>
                                <h3 id="saldoPendiente">-</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-hourglass-half fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stats-card primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Por Acreditar</h6>
                                <h3 id="porAcreditar">-</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-clock fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card stats-card info">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title">Saldo Actual</h6>
                                <h3 id="saldoActual">-</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-wallet fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista Unificada de Movimientos -->
        <div class="card">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>Mis Movimientos
                        </h5>
                    </div>
                    <div class="col-auto">
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="filterMovimientos('')">Todos</button>
                            <button type="button" class="btn btn-outline-success" onclick="filterMovimientos('acreditacion')">Acreditaciones</button>
                            <button type="button" class="btn btn-outline-warning" onclick="filterMovimientos('comprobante')">Pendientes</button>
                            <button type="button" class="btn btn-outline-info" onclick="filterMovimientos('credito')">Cr√©ditos</button>
                            <button type="button" class="btn btn-outline-danger" onclick="filterMovimientos('pago')">Pagos</button>
                        </div>
                        <span class="badge bg-info ms-2" id="movimientosCount">0</span>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortMovimientos('fecha')">Fecha</th>
                                <th class="sortable" onclick="sortMovimientos('tipo')">Tipo</th>
                                <th class="sortable" onclick="sortMovimientos('concepto')">Concepto</th>
                                <th class="sortable" onclick="sortMovimientos('importe')">Importe</th>
                                <th>Comisi√≥n</th>
                                <th>Neto</th>
                                <th>Detalles</th>
                                <th class="text-end saldo-acumulado-header" id="saldoAcumuladoHeader">Saldo Acumulado</th>
                            </tr>
                        </thead>
                        <tbody id="movimientosUnificadosTableBody">
                            <tr>
                                <td colspan="8" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <div class="row align-items-center">
                    <div class="col">
                        <small class="text-muted" id="movimientosUnificadosPaginationInfo">
                            Mostrando 0 de 0 movimientos
                        </small>
                    </div>
                    <div class="col-auto d-flex align-items-center gap-2">
                        <small class="text-muted">Mostrar:</small>
                        <select class="form-select form-select-sm" id="movimientosPerPage" onchange="changeMovimientosPerPage()" style="width: auto;">
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="500">500</option>
                        </select>
                        <nav aria-label="Paginaci√≥n de movimientos">
                            <ul class="pagination pagination-sm mb-0" id="movimientosUnificadosPagination">
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Perfil -->
    <div class="modal fade" id="profileModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-circle me-2"></i>Mi Perfil
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="profileContent">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/utils.js"></script>
    <script>
        // Variables globales
        let currentUser = null;
        let movimientosFilter = '';
        let allMovimientos = []; // Todos los movimientos cargados
        let currentPage = 1;
        let movimientosPerPage = 25;
        let currentSort = { field: 'fecha', order: 'desc' }; // Estado del ordenamiento
        let saldoInicialCliente = 0; // Saldo inicial del cliente
        
        // Variables de paginaci√≥n del servidor
        let movimientosPage = 1;
        let movimientosLimit = 100;
        let movimientosTotal = 0;
        let movimientosPages = 1;

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadUserInfo();
            loadResumen();
            loadMovimientosUnificados();
            
            // Actualizar datos cada 30 segundos
            setInterval(() => {
                loadResumen();
                loadMovimientosUnificados();
            }, 30000);
        });

        // Verificar autenticaci√≥n
        function checkAuth() {
            const token = localStorage.getItem('portal_token');
            if (!token) {
                window.location.href = '/portal-login.html';
                return;
            }
        }

        // Cargar informaci√≥n del usuario
        async function loadUserInfo() {
            try {
                const response = await authenticatedRequest('/portal/profile');
                if (!response) return;

                const result = await response.json();
                if (result.success) {
                    currentUser = result.data;
                    document.getElementById('userName').textContent = `${currentUser.nombre} ${currentUser.apellido}`;
                    
                    // Mostrar comisi√≥n del cliente
                    const comisionElement = document.getElementById('userComision');
                    if (currentUser.comision && currentUser.comision > 0) {
                        comisionElement.textContent = `Comisi√≥n: ${currentUser.comision}%`;
                        comisionElement.style.display = 'inline';
                    } else {
                        comisionElement.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error cargando informaci√≥n del usuario:', error);
                // Fallback a datos locales
            const userStr = localStorage.getItem('portal_user');
            if (userStr) {
                currentUser = JSON.parse(userStr);
                document.getElementById('userName').textContent = `${currentUser.nombre} ${currentUser.apellido}`;
                }
            }
        }

        // Funci√≥n para hacer requests autenticados
        async function authenticatedRequest(url, options = {}) {
            const token = localStorage.getItem('portal_token');
            if (!token) {
                window.location.href = '/portal-login.html';
                return null;
            }

            const response = await fetch(url, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });

            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('portal_token');
                localStorage.removeItem('portal_user');
                window.location.href = '/portal-login.html';
                return null;
            }

            return response;
        }

        // Cargar resumen
        async function loadResumen() {
            try {
                const response = await authenticatedRequest('/portal/resumen');
                if (!response) return;

                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    
                    document.getElementById('totalAcreditaciones').textContent = data.acreditaciones.total_acreditaciones || 0;
                    
                    const porAcreditar = data.porAcreditar || 0;
                    let saldo_actual = data.saldo_actual || 0;

                    // Restar comisiones de fondos liberados seg√∫n lo solicitado
                    if (data.debug_saldo) {
                        const comisiones_acreditaciones_liberadas = data.debug_saldo.comisiones_acreditaciones_liberadas || 0;
                        const comisiones_depositos_liberados = data.debug_saldo.comisiones_depositos_liberados || 0;
                        
                        // Aplicar la f√≥rmula: saldo_actual = saldo_actual - comisiones_acreditaciones_liberadas - comisiones_depositos_liberados
                        saldo_actual = saldo_actual - comisiones_acreditaciones_liberadas - comisiones_depositos_liberados;
                        
                        console.log('üîç Portal Dashboard - Ajuste de saldo actual:', {
                            saldo_original: data.saldo_actual,
                            comisiones_acreditaciones_liberadas,
                            comisiones_depositos_liberados,
                            saldo_final: saldo_actual
                        });
                    }

                    // Mostrar el campo Por Acreditar
                    const porAcreditarElement = document.getElementById('porAcreditar');
                    if (porAcreditarElement) {
                        porAcreditarElement.textContent = new Intl.NumberFormat('es-AR', {
                            style: 'currency',
                            currency: 'ARS'
                        }).format(porAcreditar);
                    }

                    // Ajustar el saldo actual mostrado (ya con comisiones restadas)
                    const saldoActualElement = document.getElementById('saldoActual');
                    saldoActualElement.textContent = new Intl.NumberFormat('es-AR', {
                        style: 'currency',
                        currency: 'ARS'
                    }).format(saldo_actual);

                    if (saldo_actual > 0) {
                        saldoActualElement.className = 'balance-positive';
                    } else if (saldo_actual < 0) {
                        saldoActualElement.className = 'balance-negative';
                    } else {
                        saldoActualElement.className = 'balance-zero';
                    }

                    // Guardar el saldo actual como saldo inicial para los c√°lculos de saldo acumulado
                    saldoInicialCliente = saldo_actual;
                    
                    // Saldo pendiente (comprobantes sin acreditar)
                    const saldoPendiente = data.comprobantes_pendientes?.total_importe_comprobantes_pendientes || 0;
                    const saldoPendienteElement = document.getElementById('saldoPendiente');
                    saldoPendienteElement.textContent = new Intl.NumberFormat('es-AR', {
                        style: 'currency',
                        currency: 'ARS'
                    }).format(saldoPendiente);


                }
            } catch (error) {
                console.error('Error cargando resumen:', error);
            }
        }

        // Funci√≥n auxiliar para obtener el cliente_id del token
        async function getClienteId() {
            const token = localStorage.getItem('portal_token');
            if (!token) return null;
            
            try {
                const response = await fetch('/portal/profile', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.data.cliente_id;
                }
            } catch (error) {
                console.error('Error obteniendo cliente_id:', error);
            }
            
            return null;
        }

        // Cargar movimientos unificados usando paginaci√≥n del servidor
        async function loadMovimientosUnificados() {
            try {
                const response = await authenticatedRequest(`/portal/movimientos-unificados?page=${movimientosPage}&limit=${movimientosLimit}`);
                if (!response) return;

                const result = await response.json();
                if (!result.success) {
                    console.error('Error al cargar movimientos unificados:', result);
                    return;
                }

                // Guardar movimientos y datos de paginaci√≥n
                allMovimientos = result.data;
                movimientosTotal = result.pagination?.total || allMovimientos.length;
                movimientosPages = result.pagination?.pages || 1;
                
                // Inicializar indicadores de ordenamiento
                updateSortIndicators(currentSort.field);
                
                displayMovimientosUnificados();
                updateMovimientosPagination();
            } catch (error) {
                console.error('Error cargando movimientos unificados:', error);
                showAlert('Error al cargar movimientos unificados', 'danger');
            }
        }

        // Mostrar movimientos unificados con paginaci√≥n
        function displayMovimientosUnificados() {
            // Aplicar filtro si est√° activo
            let movimientosFiltrados = allMovimientos;
            if (movimientosFilter) {
                switch (movimientosFilter) {
                    case 'acreditacion':
                        movimientosFiltrados = allMovimientos.filter(mov => mov.tipo === 'acreditacion');
                        break;
                    case 'comprobante':
                        movimientosFiltrados = allMovimientos.filter(mov => mov.tipo === 'comprobante');
                        break;
                    case 'credito':
                        movimientosFiltrados = allMovimientos.filter(mov => mov.tipo === 'credito');
                        break;
                    case 'pago':
                        movimientosFiltrados = allMovimientos.filter(mov => mov.tipo === 'pago');
                        break;
                    default:
                        movimientosFiltrados = allMovimientos;
                }
            }

            // Mostrar/ocultar columna de saldo acumulado seg√∫n el filtro
            const saldoAcumuladoHeader = document.getElementById('saldoAcumuladoHeader');
            
            if (movimientosFilter === '') {
                // Vista "Todos" - mostrar columna de saldo acumulado
                if (saldoAcumuladoHeader) saldoAcumuladoHeader.style.display = '';
            } else {
                // Otras vistas - ocultar columna de saldo acumulado
                if (saldoAcumuladoHeader) saldoAcumuladoHeader.style.display = 'none';
            }

            const tbody = document.getElementById('movimientosUnificadosTableBody');
            const total = movimientosFiltrados.length;
            
            if (total === 0) {
                const colspan = movimientosFilter === '' ? 8 : 7; // 8 columnas si est√° "Todos", 7 si es filtrado
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${colspan}" class="text-center py-4 text-muted">
                            <i class="fas fa-inbox fa-2x mb-2"></i><br>
                            ${movimientosFilter ? `No se encontraron movimientos de tipo "${movimientosFilter}"` : 'No se encontraron movimientos'}
                        </td>
                    </tr>
                `;
                updatePaginationInfo(0, 0, 0);
                updatePaginationControls(0);
                return;
            }

            // Ordenar movimientos por fecha (m√°s antiguos primero para calcular saldo acumulado)
            // Usar ID como criterio secundario para movimientos con la misma fecha
            const movimientosOrdenados = [...movimientosFiltrados].sort((a, b) => {
                const fechaA = new Date(a.fecha_original || a.fecha || a.fecha_pago || a.fecha_hora || a.created_at);
                const fechaB = new Date(b.fecha_original || b.fecha || b.fecha_pago || b.fecha_hora || b.created_at);
                
                // Si las fechas son iguales, ordenar por ID (m√°s reciente primero)
                if (fechaA.getTime() === fechaB.getTime()) {
                    return (b.id || 0) - (a.id || 0);
                }
                
                return fechaA - fechaB;
            });

                              // Calcular saldo acumulado ANTES de cada movimiento (como un extracto bancario)
            // Empezamos desde el saldo actual y vamos hacia atr√°s en el tiempo
            
            // Primero procesamos los movimientos para determinar cu√°les est√°n liberados
            const movimientosProcesados = movimientosOrdenados.map(mov => {
                // Determinar si es entrada o salida Y si est√° liberado
                let esEntrada = false;
                let estaLiberado = true; // Por defecto asumimos que est√° liberado
                const fechaActual = new Date();
                
                if (mov.tipo === 'acreditacion' || (mov.tipo === 'comprobante' && mov.id_acreditacion)) {
                    esEntrada = true;
                    // Para acreditaciones, verificar si est√° liberado seg√∫n la fecha estimada
                    if (mov.fecha_estimada_liberacion) {
                        estaLiberado = fechaActual >= new Date(mov.fecha_estimada_liberacion);
                    } else {
                        estaLiberado = true; // Si no hay fecha estimada, asumimos liberado
                    }
                } else if (mov.tipo === 'credito') {
                    esEntrada = true;
                    // Los cr√©ditos tipo dep√≥sito pueden tener plazo de liberaci√≥n
                    if (mov.metodo_pago && mov.metodo_pago.toLowerCase() === 'deposito') {
                        if (mov.fecha_estimada_liberacion) {
                            estaLiberado = fechaActual >= new Date(mov.fecha_estimada_liberacion);
                        } else {
                            estaLiberado = mov.esta_liberado !== false; // Si no est√° definido, asumimos liberado
                        }
                    } else {
                        estaLiberado = true; // Otros cr√©ditos est√°n inmediatamente disponibles
                    }
                } else if (mov.tipo === 'pago') {
                    esEntrada = false;
                    estaLiberado = true; // Los pagos siempre restan inmediatamente
                }

                // Calcular importe neto (descontando comisiones)
                const importeBruto = parseFloat(mov.importe || 0);
                const comision = parseFloat(mov.importe_comision || 0);
                const importeNeto = importeBruto - comision;

                return {
                    ...mov,
                    esEntrada: esEntrada,
                    importeNeto: importeNeto,
                    estaLiberado: estaLiberado,
                    importeBruto: importeBruto
                };
            });

                  // L√≥gica de extracto bancario: calcular saldo acumulado desde el m√°s reciente hacia atr√°s
      // El primer movimiento (m√°s reciente) muestra el saldo actual
      // Luego vamos hacia atr√°s restando/sumando seg√∫n el tipo de movimiento
      
      // Ordenar movimientos procesados por fecha (m√°s reciente primero) y por ID (m√°s reciente primero)
      const movimientosParaCalcular = movimientosProcesados.sort((a, b) => {
        const fechaA = new Date(a.fecha_original || a.fecha || a.fecha_pago || a.fecha_hora || a.created_at);
        const fechaB = new Date(b.fecha_original || b.fecha || b.fecha_pago || b.fecha_hora || b.created_at);
        
        if (fechaA.getTime() === fechaB.getTime()) {
          return (b.id || 0) - (a.id || 0);
        }
        
        return fechaB - fechaA;
      });
      
      // Calcular saldo acumulado
      let saldoAcumulado = saldoInicialCliente;
      const movimientosConSaldo = [];
      
      movimientosParaCalcular.forEach(mov => {
        // El saldo acumulado es el saldo ANTES del movimiento
        const saldoAntes = saldoAcumulado;
        
        // Solo procesar movimientos liberados (los pendientes no afectan el saldo)
        if (mov.estaLiberado) {
          if (mov.esEntrada) {
            // Es un COBRO (cr√©dito): RESTAR el importe neto del saldo
            saldoAcumulado -= mov.importeNeto;
          } else {
            // Es un PAGO (d√©bito): SUMAR el importe bruto al saldo
            saldoAcumulado += mov.importeBruto;
          }
        }
        
        movimientosConSaldo.push({
          ...mov,
          saldoAcumulado: saldoAntes // Saldo ANTES del movimiento
        });
      });
      
      // Ordenar movimientosConSaldo por fecha (m√°s reciente primero) y ID
      movimientosConSaldo.sort((a, b) => {
        const fechaA = new Date(a.fecha_original || a.fecha || a.fecha_pago || a.fecha_hora || a.created_at);
        const fechaB = new Date(b.fecha_original || b.fecha || b.fecha_pago || b.fecha_hora || b.created_at);
        
        if (fechaA.getTime() === fechaB.getTime()) {
          return (b.id || 0) - (a.id || 0);
        }
        
        return fechaB - fechaA;
      });

            // Ordenar nuevamente por fecha (m√°s recientes primero para mostrar)
            const movimientosParaMostrar = movimientosConSaldo.sort((a, b) => {
                const fechaA = new Date(a.fecha_original || a.fecha || a.fecha_pago || a.fecha_hora || a.created_at);
                const fechaB = new Date(b.fecha_original || b.fecha || b.fecha_pago || b.fecha_hora || b.created_at);
                return fechaB - fechaA;
            });

            // Con paginaci√≥n del servidor, ya tenemos los movimientos de la p√°gina actual
            const movimientosPagina = movimientosParaMostrar;

            // Actualizar informaci√≥n de paginaci√≥n del servidor
            updateMovimientosPagination();
            updatePaginationControls(movimientosPages);

            // Transformar comprobantes con acreditaci√≥n vinculada a tipo 'acreditacion'
            const movimientosTransformados = movimientosPagina.map(mov => {
                if (mov.tipo === 'comprobante' && mov.id_acreditacion) {
                    return { ...mov, tipo: 'acreditacion' };
                }
                return mov;
            });

            tbody.innerHTML = movimientosTransformados.map(mov => {
                const isEntrada = mov.es_entrada;
                let icon = '';
                let badgeClass = '';
                let badgeText = '';
                let tipoText = '';
                let importeClass = '';
                // Variable botonBorrar removida ya que no se usa

                if (mov.tipo === 'comprobante' && mov.id_acreditacion) {
                    icon = 'fas fa-university';
                    badgeClass = 'bg-success'; // SIEMPRE verde para acreditaci√≥n
                    badgeText = mov.cotejado ? 'Cotejada' : 'Acreditaci√≥n';
                    tipoText = 'Acreditaci√≥n';
                    importeClass = 'text-primary';
                } else if (mov.tipo === 'acreditacion') {
                    icon = 'fas fa-university';
                    badgeClass = 'bg-success';
                    badgeText = mov.cotejado ? 'Cotejada' : 'Acreditaci√≥n';
                    tipoText = 'Acreditaci√≥n';
                    importeClass = 'text-primary';
                } else if (mov.tipo === 'comprobante') {
                    icon = 'fas fa-file-alt';
                    badgeClass = 'bg-warning';
                    badgeText = 'Sin acreditar';
                    tipoText = 'Comprobante';
                    importeClass = 'text-primary';
                } else if (mov.tipo === 'credito') {
                    icon = 'fas fa-plus-circle';
                    badgeClass = 'bg-success';
                    badgeText = mov.estado || 'Confirmado';
                    tipoText = 'Cr√©dito';
                    importeClass = 'text-success';
                } else if (mov.tipo === 'credito' && mov.metodo_pago && mov.metodo_pago.toLowerCase() === 'deposito') {
                    // Dep√≥sitos: mostrar como ingresos con icono de banco
                    icon = 'fas fa-university';
                    badgeClass = 'bg-info';
                    badgeText = mov.esta_liberado ? 'Liberado' : 'Pendiente';
                    tipoText = 'Dep√≥sito';
                    importeClass = 'text-primary';
                } else if (mov.tipo === 'pago') {
                    icon = 'fas fa-minus-circle';
                    badgeClass = 'bg-danger';
                    badgeText = mov.estado || 'Confirmado';
                    tipoText = 'Pago';
                    importeClass = 'text-danger';
                }

                let comision = parseFloat(mov.comision) || 0;
                let importeComision = parseFloat(mov.importe_comision) || 0;
                const neto = mov.importe - importeComision;

                // Formatear saldo acumulado
                const saldoAcumuladoFormatted = new Intl.NumberFormat('es-AR', {
                    style: 'currency',
                    currency: 'ARS'
                }).format(mov.saldoAcumulado || 0);
                const saldoClass = (mov.saldoAcumulado || 0) >= 0 ? 'text-success' : 'text-danger';
                
                // Agregar indicador si el movimiento no est√° liberado
                let saldoContent = saldoAcumuladoFormatted;
                if (!mov.estaLiberado && mov.esEntrada) {
                    saldoContent += ` <small class="text-muted" title="Pendiente de liberaci√≥n">‚è≥</small>`;
                }

                // En el portal de clientes no se permite borrar movimientos
                // La columna de acciones ha sido removida

                // Construir fila base
                let rowHTML = `
                    <tr>
                        <td>${mov.tipo === 'comprobante' ? formatDatePreserveTime(mov.fecha) : formatDate(mov.fecha)}</td>
                        <td>
                            <span class="badge ${badgeClass} ms-1">${tipoText}</span>
                        </td>
                        <td>
                            <strong>${(mov.concepto || '').replace(/^\s*[^\w\s]*\s*/, '')}</strong>
                            ${mov.tipo === 'comprobante' && !mov.id_acreditacion ? `<span class="text-warning ms-1" data-bs-toggle="tooltip" data-bs-placement="top" title="Sin vincular a acreditaci√≥n">‚ö†Ô∏è</span>` : ''}
                        </td>
                        <td>
                            <div class="h5 mb-0 ${importeClass}" 
                                 ${mov.fecha_estimada_liberacion ? `data-bs-toggle="tooltip" data-bs-placement="top" title="Fecha estimada de liberaci√≥n: ${formatFechaLiberacion(mov.fecha_estimada_liberacion)}"` : ''}>
                                ${mov.tipo === 'pago' ? '-' : ''}$${parseFloat(mov.importe || 0).toLocaleString('es-AR', { minimumFractionDigits: 2 })}
                                ${mov.fecha_estimada_liberacion ? (mov.esta_liberado ? '<i class="fas fa-check-circle text-success ms-1" style="font-size: 0.8em;" title="Fondo liberado"></i>' : '<i class="fas fa-clock text-muted ms-1" style="font-size: 0.8em;" title="Pendiente de liberaci√≥n"></i>') : ''}
                            </div>
                        </td>
                        <td>
                            ${comision > 0 ? `${comision}%` : '-'}
                        </td>
                        <td>
                            ${comision > 0 ? `$${neto.toLocaleString('es-AR', { minimumFractionDigits: 2 })}` : '-'}
                        </td>
                        <td>
                            ${mov.cuit ? `<small><strong>CUIT:</strong> ${mov.cuit}</small><br>` : ''}
                            ${mov.metodo_pago ? `<small><strong>M√©todo:</strong> ${mov.metodo_pago}</small><br>` : ''}
                            ${mov.referencia ? `<small><strong>Ref:</strong> ${mov.referencia}</small><br>` : ''}
                            ${mov.tipo === 'comprobante' && mov.id_acreditacion ? `<div class='mt-1'><small class='text-success'><strong>Vinculado a Acreditaci√≥n:</strong> ${mov.id_acreditacion}</small></div>` : ''}
                        </td>`;

                // Agregar columna de saldo acumulado solo si estamos en la vista "Todos"
                if (movimientosFilter === '') {
                    rowHTML += `<td class="text-end fw-bold ${saldoClass}">${saldoContent}</td>`;
                }

                // Cerrar la fila
                rowHTML += `</tr>`;

                return rowHTML;
            }).join('');

            // Actualizar contador de movimientos
            const movimientosCountElement = document.getElementById('movimientosCount');
            if (movimientosCountElement) {
                movimientosCountElement.textContent = movimientosTotal;
            }

            // Inicializar tooltips despu√©s de poblar la tabla
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        // Actualizar informaci√≥n de paginaci√≥n
        function updatePaginationInfo(start, end, total) {
            const infoElement = document.getElementById('movimientosUnificadosPaginationInfo');
            infoElement.textContent = `Mostrando ${start} a ${end} de ${total} movimientos`;
        }

        // Actualizar paginaci√≥n de movimientos del servidor
        function updateMovimientosPagination() {
            const infoElement = document.getElementById('movimientosUnificadosPaginationInfo');
            infoElement.textContent = `P√°gina ${movimientosPage} de ${movimientosPages} ‚Ä¢ Total: ${movimientosTotal} movimientos`;
        }

        // Actualizar controles de paginaci√≥n
        function updatePaginationControls(totalPages) {
            const paginationElement = document.getElementById('movimientosUnificadosPagination');
            
            if (totalPages <= 1) {
                paginationElement.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Bot√≥n anterior
            paginationHTML += `
                <li class="page-item ${movimientosPage <= 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="goToPage(${movimientosPage - 1}); return false;">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;
            
            // P√°ginas
            const startPage = Math.max(1, movimientosPage - 2);
            const endPage = Math.min(totalPages, movimientosPage + 2);
            
            // Primera p√°gina si no est√° visible
            if (startPage > 1) {
                paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="goToPage(1); return false;">1</a>
                    </li>
                `;
                if (startPage > 2) {
                    paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
            
            // P√°ginas visibles
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <li class="page-item ${i === movimientosPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a>
                    </li>
                `;
            }
            
            // √öltima p√°gina si no est√° visible
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="goToPage(${totalPages}); return false;">${totalPages}</a>
                    </li>
                `;
            }
            
            // Bot√≥n siguiente
            paginationHTML += `
                <li class="page-item ${movimientosPage >= totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="goToPage(${movimientosPage + 1}); return false;">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;
            
            paginationElement.innerHTML = paginationHTML;
        }

        // Ir a p√°gina espec√≠fica
        function goToPage(page) {
            if (page < 1 || page > movimientosPages) return;
            movimientosPage = page;
            loadMovimientosUnificados();
        }

        // Cambiar cantidad de movimientos por p√°gina
        function changeMovimientosPerPage() {
            const select = document.getElementById('movimientosPerPage');
            movimientosLimit = parseInt(select.value);
            movimientosPage = 1; // Resetear a primera p√°gina
            loadMovimientosUnificados();
        }

        // Actualizar paginaci√≥n de movimientos
        function updateMovimientosPagination(pagination) {
            const paginationElement = document.getElementById('movimientosUnificadosPagination');
            const infoElement = document.getElementById('movimientosUnificadosPaginationInfo');
            
            infoElement.textContent = `Mostrando ${pagination.page} de ${pagination.pages} p√°ginas (${pagination.total} movimientos total)`;
            
            let paginationHTML = '';
            
            // Bot√≥n anterior
            paginationHTML += `
                <li class="page-item ${pagination.page <= 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changeMovimientosPage(${pagination.page - 1})">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;
            
            // P√°ginas
            const startPage = Math.max(1, pagination.page - 2);
            const endPage = Math.min(pagination.pages, pagination.page + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <li class="page-item ${i === pagination.page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changeMovimientosPage(${i})">${i}</a>
                    </li>
                `;
            }
            
            // Bot√≥n siguiente
            paginationHTML += `
                <li class="page-item ${pagination.page >= pagination.pages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changeMovimientosPage(${pagination.page + 1})">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;
            
            paginationElement.innerHTML = paginationHTML;
        }

        // Cambiar p√°gina de movimientos
        function changeMovimientosPage(page) {
            movimientosPage = page;
            loadMovimientos();
        }

        // Filtrar movimientos
        function filterMovimientos(tipo) {
            movimientosFilter = tipo;
            movimientosPage = 1; // Resetear paginaci√≥n del servidor al filtrar
            
            // Actualizar estado visual de los botones
            const buttons = document.querySelectorAll('.btn-group .btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('btn-outline-primary', 'btn-outline-success', 'btn-outline-warning', 'btn-outline-info', 'btn-outline-danger');
            });
            
            // Activar el bot√≥n seleccionado
            const activeButton = event.target;
            if (activeButton) {
                activeButton.classList.remove('btn-outline-primary', 'btn-outline-success', 'btn-outline-warning', 'btn-outline-info', 'btn-outline-danger');
                activeButton.classList.add('active');
            }
            
            loadMovimientosUnificados(); // Recargar desde el servidor con el filtro
        }

        // Ordenar movimientos
        function sortMovimientos(field) {
            // Cambiar orden si es el mismo campo, sino usar ascendente
            if (currentSort.field === field) {
                currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.order = 'asc';
            }
            
            // Aplicar ordenamiento a todos los movimientos
            allMovimientos.sort((a, b) => {
                let valueA, valueB;
                
                switch (field) {
                    case 'fecha':
                        valueA = a.fecha_original ? new Date(a.fecha_original) : new Date(0);
                        valueB = b.fecha_original ? new Date(b.fecha_original) : new Date(0);
                        break;
                    case 'tipo':
                        valueA = a.tipo || '';
                        valueB = b.tipo || '';
                        break;
                    case 'concepto':
                        valueA = a.concepto || '';
                        valueB = b.concepto || '';
                        break;
                    case 'importe':
                        valueA = parseFloat(a.importe) || 0;
                        valueB = parseFloat(b.importe) || 0;
                        break;
                    default:
                        return 0;
                }
                
                // Comparar valores
                let comparison = 0;
                if (valueA > valueB) {
                    comparison = 1;
                } else if (valueA < valueB) {
                    comparison = -1;
                }
                
                // Aplicar orden
                return currentSort.order === 'desc' ? -comparison : comparison;
            });
            
            // Actualizar indicadores visuales en los headers
            updateSortIndicators(field);
            
            // Resetear a primera p√°gina y mostrar
            currentPage = 1;
            displayMovimientosUnificados();
        }
        
        // Actualizar indicadores visuales de ordenamiento
        function updateSortIndicators(activeField) {
            // Remover todos los indicadores existentes
            document.querySelectorAll('.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
            
            // Agregar indicador al campo activo
            const activeHeader = document.querySelector(`th[onclick="sortMovimientos('${activeField}')"]`);
            if (activeHeader) {
                activeHeader.classList.add(`sort-${currentSort.order}`);
            }
        }

        // Mostrar perfil
        async function showProfile() {
            try {
                const response = await authenticatedRequest('/portal/profile');
                if (!response) return;

                const result = await response.json();
                
                if (result.success) {
                    const user = result.data;
                    document.getElementById('profileContent').innerHTML = `
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Usuario:</strong></p>
                                <p><strong>Nombre:</strong></p>
                                <p><strong>Email:</strong></p>
                                <p><strong>Estado:</strong></p>
                                <p><strong>Fecha Registro:</strong></p>
                                <p><strong>√öltimo Acceso:</strong></p>
                            </div>
                            <div class="col-md-6">
                                <p>${user.username}</p>
                                <p>${user.nombre} ${user.apellido}</p>
                                <p>${user.email || '<span class="text-muted">No especificado</span>'}</p>
                                <p>
                                    <span class="badge bg-${user.cliente_estado === 'activo' ? 'success' : 'warning'}">
                                        ${user.cliente_estado}
                                    </span>
                                </p>
                                <p>${new Date(user.fecha_registro).toLocaleDateString('es-AR')}</p>
                                <p>${user.ultimo_acceso ? new Date(user.ultimo_acceso).toLocaleString('es-AR') : 'Nunca'}</p>
                            </div>
                        </div>
                    `;
                } else {
                    document.getElementById('profileContent').innerHTML = `
                        <div class="alert alert-danger">
                            Error al cargar el perfil: ${result.message}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('profileContent').innerHTML = `
                    <div class="alert alert-danger">
                        Error de conexi√≥n al cargar el perfil
                    </div>
                `;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('profileModal'));
            modal.show();
        }

        // Cerrar sesi√≥n
        function logout() {
            localStorage.removeItem('portal_token');
            localStorage.removeItem('portal_user');
            window.location.href = '/portal-login.html';
        }

        // Mostrar alerta
        function showAlert(message, type) {
            const alertsContainer = document.getElementById('alerts');
            const alertId = 'alert-' + Date.now();
            
            const alertHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" id="${alertId}" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertsContainer.innerHTML = alertHTML;
            
            // Auto-dismiss despu√©s de 5 segundos
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }

        // Funci√≥n de debug para portal-dashboard
        window.debugPortalDashboard = function() {
            console.log('üîç === DEBUG PORTAL DASHBOARD ===');
            console.log('üìä allMovimientos:', allMovimientos);
            console.log('üîß movimientosFilter:', movimientosFilter);
            console.log('üìÑ currentUser:', currentUser);
            
            console.log('\nüìã === AN√ÅLISIS DE MOVIMIENTOS ===');
            allMovimientos.forEach((mov, index) => {
                console.log(`Movimiento ${index}:`, {
                    id: mov.id,
                    tipo: mov.tipo,
                    tipo_pago: mov.tipo_pago,
                    concepto: mov.concepto,
                    importe: mov.importe,
                    comision: mov.comision,
                    importe_comision: mov.importe_comision,
                    es_entrada: mov.es_entrada,
                    estado: mov.estado,
                    cotejado: mov.cotejado
                });
            });
            
            console.log('\nüé® === BADGES ===');
            allMovimientos.forEach((mov, index) => {
                let badgeClass = '';
                let tipoText = '';
                
                if (mov.tipo === 'acreditacion') {
                    badgeClass = 'bg-success';
                    tipoText = 'Acreditaci√≥n';
                } else if (mov.tipo === 'comprobante') {
                    badgeClass = 'bg-warning';
                    tipoText = 'Comprobante';
                } else if (mov.tipo === 'movimiento' && mov.tipo_pago === 'credito') {
                    badgeClass = 'bg-success';
                    tipoText = 'Cr√©dito';
                } else if (mov.tipo === 'movimiento' && mov.tipo_pago === 'egreso') {
                    badgeClass = 'bg-danger';
                    tipoText = 'Pago';
                }
                
                console.log(`Movimiento ${index} (${mov.tipo}): badgeClass="${badgeClass}", tipoText="${tipoText}"`);
            });
        };

        // En el portal de clientes no se permite borrar movimientos
        // Las funciones de borrado han sido removidas por seguridad

        // Funci√≥n para formatear fecha de liberaci√≥n en formato DD/MM - HH:MM
        function formatFechaLiberacion(fechaISO) {
            if (!fechaISO) return '';
            
            try {
                const fecha = new Date(fechaISO);
                const dia = fecha.getDate().toString().padStart(2, '0');
                const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
                const hora = fecha.getHours().toString().padStart(2, '0');
                const minutos = fecha.getMinutes().toString().padStart(2, '0');
                
                return `${dia}/${mes} - ${hora}:${minutos}`;
            } catch (error) {
                console.error('Error formateando fecha de liberaci√≥n:', error);
                return fechaISO; // Fallback al formato original
            }
        }
    </script>
</body>
</html> 